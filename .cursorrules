# Open Doors Billing - AI Assistant Rules

## IMPORTANTE: ESTE ES C√ìDIGO DE REFERENCIA DESDE REPLIT

Este c√≥digo fue desarrollado en Replit y es la FUENTE DE VERDAD.
Tu c√≥digo local debe sincronizarse con este.

## ARQUITECTURA COMPLETA

```
/
‚îú‚îÄ‚îÄ src/                          # Backend Python/FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routers/              # Endpoints REST
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py           # Autenticaci√≥n JWT
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ invoices.py       # CRUD facturas + autoguardado
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ partners.py       # Gesti√≥n socios
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ financial_reports.py  # Balance IVA/General
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analysis.py       # An√°lisis financiero
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ approval.py       # Aprobaciones
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deps.py               # Dependencias inyecci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py             # Settings
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py           # PostgreSQL setup
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.py           # JWT & bcrypt
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ permissions.py        # Sistema de roles
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py               # Usuario + roles
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ invoice.py            # Factura fiscal argentina
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ partner.py            # Socios/proveedores
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ financial_calculator.py  # L√≥gica fiscal Joni
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ currency_validator.py   # Validaci√≥n $1.234,56
‚îÇ   ‚îî‚îÄ‚îÄ main.py                   # FastAPI app
‚îú‚îÄ‚îÄ alembic/                      # Migraciones DB (si existe)
‚îú‚îÄ‚îÄ tests/                        # Tests pytest
‚îú‚îÄ‚îÄ GUIA_*.txt                    # Documentaci√≥n completa
‚îî‚îÄ‚îÄ requirements.txt              # Dependencias
```

## REGLAS FISCALES CR√çTICAS (SEG√öN JONI - NO MODIFICAR)

### Balance IVA
```python
# SOLO facturas tipo A (con IVA discriminado)
# Excluir: es_compensacion_iva=True
# Formula: IVA emitido - IVA recibido
```

### Balance General
```python
# SOLO facturas con movimiento_cuenta=SI
# Representa flujo de caja real
# Formula: Ingresos - Egresos (solo movimientos reales)
```

### Formato Moneda Argentina
```python
# SIEMPRE: $1.234,56
# Punto para miles
# Coma para decimales
# Auto-correcci√≥n de formato ingl√©s ($1,234.56 ‚Üí $1.234,56)
```

### Tipos de Factura
- **Tipo A**: Con IVA discriminado ‚Üí Cuenta para Balance IVA ‚úÖ
- **Tipo B**: IVA incluido ‚Üí NO cuenta para Balance IVA ‚ùå
- **Tipo C**: Sin IVA ‚Üí NO cuenta para Balance IVA ‚ùå
- **Tipo X**: Otros comprobantes ‚Üí NO cuenta para Balance IVA ‚ùå

## SISTEMA DE PERMISOS JER√ÅRQUICO

7 roles (de mayor a menor):
1. **superadmin** - Control total (SOLO Franco: cortsfranco@hotmail.com)
2. **admin** - Gesti√≥n completa (Hern√°n, Joni)
3. **accountant** - Contabilidad y reportes
4. **approver** - Aprobaci√≥n de pagos
5. **editor** - Edici√≥n de facturas
6. **partner** - Vista de sus facturas
7. **viewer** - Solo lectura

**CR√çTICO**: NUNCA crear otro superadmin. Solo existe Franco.

## MULTI-PARTNER TRACKING

5 socios principales:
- Franco (SUPERADMIN)
- Joni
- Hern√°n
- Maxi
- Leo

Cada factura DEBE tener `socio_responsable` asignado.

## CONVENCIONES DE C√ìDIGO

### Python/FastAPI Backend
```python
# Type hints OBLIGATORIOS
def calcular_balance_iva(
    self, 
    facturas: List[Invoice],
    excluir_compensaciones: bool = True
) -> Decimal:
    """Calcula Balance IVA seg√∫n normativa argentina."""
    pass

# Async/await SIEMPRE en endpoints
@router.get("/invoices/{invoice_id}")
async def get_invoice(
    invoice_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
) -> Invoice:
    pass

# SQLModel para modelos
class Invoice(SQLModel, table=True):
    __tablename__ = "invoices"
    id: Optional[int] = Field(default=None, primary_key=True)
    # ...

# Servicios para l√≥gica de negocio (NO en routers)
# ‚úÖ Correcto: router ‚Üí service ‚Üí model
# ‚ùå Incorrecto: router ‚Üí model directamente

# Soft delete (nunca hard delete)
invoice.deleted_at = datetime.utcnow()
# NO: db.delete(invoice)

# Validaciones con Pydantic
class InvoiceCreate(BaseModel):
    monto_total: Decimal = Field(gt=0)
    fecha_emision: date
```

### TypeScript/React Frontend (cuando se implemente)
```typescript
// Functional components con hooks
const Dashboard: React.FC = () => {
  const { data } = useFinancialData();
  return <div>...</div>;
};

// TanStack Query para datos
const { data: invoices } = useQuery({
  queryKey: ['invoices'],
  queryFn: fetchInvoices
});

// CurrencyInput para montos
<CurrencyInput
  value={amount}
  onChange={setAmount}
  format="argentine"  // $1.234,56
/>

// Recharts para gr√°ficas
<LineChart data={data}>
  <Line dataKey="balance_iva" stroke="#10b981" />
</LineChart>
```

## ENDPOINTS API PRINCIPALES

```
POST   /api/auth/login                    # Login JWT
GET    /api/auth/me                       # Usuario actual

GET    /api/invoices                      # Listar facturas
POST   /api/invoices                      # Crear factura
GET    /api/invoices/{id}                 # Obtener factura
PUT    /api/invoices/{id}                 # Actualizar factura
DELETE /api/invoices/{id}                 # Soft delete
POST   /api/invoices/{id}/restore         # Restaurar

GET    /api/v1/partners                   # Listar socios
POST   /api/v1/partners                   # Crear socio
GET    /api/v1/partners/{id}              # Obtener socio

GET    /api/v1/financial/balance-iva      # Balance IVA
GET    /api/v1/financial/balance-general  # Balance General
GET    /api/v1/financial/balance-por-socio # Por socio

GET    /api/v1/analysis/trends            # Tendencias
GET    /api/v1/analysis/comparisons       # Comparaciones

POST   /api/v1/approval/approve/{id}      # Aprobar pago
```

## VALIDACIONES OBLIGATORIAS

```python
# Coherencia de montos (en cada factura)
if invoice.tipo_factura == TipoFactura.A:
    # Debe tener subtotal + IVA = total
    assert subtotal + iva == monto_total

# Formato de moneda
assert CurrencyValidator.validar_formato(monto)  # $1.234,56

# Permisos jer√°rquicos
if action == "delete":
    assert user.role in [Role.SUPERADMIN, Role.ADMIN]

# Soft delete
assert invoice.deleted_at is not None  # NO borrar f√≠sicamente
```

## NO HACER (PROHIBIDO) ‚ùå

1. ‚ùå NO usar mock data en producci√≥n
2. ‚ùå NO hard delete (solo soft delete con deleted_at)
3. ‚ùå NO modificar l√≥gica fiscal sin validar con Joni
4. ‚ùå NO crear usuarios superadmin adicionales
5. ‚ùå NO usar localStorage para datos sensibles (solo sessionStorage para JWT temporal)
6. ‚ùå NO ignorar validaciones de coherencia de montos
7. ‚ùå NO mezclar formato ingl√©s ($1,234.56) con argentino ($1.234,56)
8. ‚ùå NO permitir facturas sin socio_responsable
9. ‚ùå NO exponer secrets en c√≥digo o logs
10. ‚ùå NO saltarse el sistema de permisos

## S√ç HACER (OBLIGATORIO) ‚úÖ

1. ‚úÖ Usar FinancialCalculator para toda l√≥gica fiscal
2. ‚úÖ Validar coherencia de montos en cada factura
3. ‚úÖ Auto-save con debounce de 1 segundo (frontend)
4. ‚úÖ Type hints en todo el c√≥digo Python
5. ‚úÖ Tests para l√≥gica fiscal cr√≠tica
6. ‚úÖ Usar design system para estilos consistentes
7. ‚úÖ Logs estructurados con niveles apropiados
8. ‚úÖ Sanitizar inputs (SQL injection, XSS)
9. ‚úÖ Rate limiting en endpoints p√∫blicos
10. ‚úÖ CORS configurado correctamente

## AZURE SERVICES INTEGRATION

```python
# Azure OpenAI (GPT-4o)
AZURE_OPENAI_ENDPOINT = env.str("AZURE_OPENAI_ENDPOINT")
AZURE_OPENAI_API_KEY = env.str("AZURE_OPENAI_API_KEY")
AZURE_OPENAI_DEPLOYMENT_NAME = "gpt-4o"

# Azure Document Intelligence
AZURE_DOC_INTELLIGENCE_ENDPOINT = env.str("AZURE_DOC_INTELLIGENCE_ENDPOINT")
AZURE_DOC_INTELLIGENCE_KEY = env.str("AZURE_DOC_INTELLIGENCE_KEY")

# Azure Cognitive Search
AZURE_SEARCH_ENDPOINT = env.str("AZURE_SEARCH_ENDPOINT")
AZURE_SEARCH_ADMIN_KEY = env.str("AZURE_SEARCH_ADMIN_KEY")

# Azure Blob Storage
AZURE_STORAGE_ACCOUNT_NAME = env.str("AZURE_STORAGE_ACCOUNT_NAME")
AZURE_STORAGE_ACCOUNT_KEY = env.str("AZURE_STORAGE_ACCOUNT_KEY")
```

## COMANDOS √öTILES

```bash
# Backend development
uvicorn src.main:app --host 0.0.0.0 --port 5000 --reload

# Testing
pytest tests/ -v
pytest tests/test_financial_calculator.py -v

# Database migrations (con Alembic)
alembic revision --autogenerate -m "Add invoice fields"
alembic upgrade head

# Production (Docker)
docker-compose up -d
docker-compose logs -f backend

# Verificar l√≥gica fiscal
python -m pytest tests/test_financial_calculator.py -v -k "balance_iva"
```

## CREDENCIALES DE DESARROLLO

```
Superadmin √∫nico:
Email: cortsfrando@hotmail.com
Password: Ncc1701E@
Rol: SUPERADMIN
```

## TESTING CR√çTICO

```python
# Tests obligatorios antes de deploy
def test_balance_iva_solo_tipo_a():
    """Balance IVA debe incluir SOLO facturas tipo A."""
    pass

def test_balance_general_solo_movimiento_cuenta_si():
    """Balance General debe incluir SOLO mov. cuenta SI."""
    pass

def test_validar_coherencia_montos():
    """Validar subtotal + IVA = total."""
    pass

def test_no_crear_superadmin_adicional():
    """Solo Franco puede ser superadmin."""
    pass

def test_soft_delete_no_hard():
    """Facturas eliminadas deben tener deleted_at."""
    pass
```

## REFERENCIAS R√ÅPIDAS

Antes de modificar l√≥gica fiscal, consultar:
1. `src/services/financial_calculator.py` - Implementaci√≥n actual
2. `src/models/invoice.py` - Estructura de datos
3. `GUIA_COMPLETA_REPLICACION.txt` - Documentaci√≥n completa
4. Transcripciones de Joni (para l√≥gica de negocio)

## DEPLOYMENT (PRODUCCI√ìN)

```yaml
# docker-compose.yml
services:
  backend:
    build: .
    ports:
      - "5000:5000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - SECRET_KEY=${SECRET_KEY}
    depends_on:
      - db
  
  db:
    image: postgres:14
    environment:
      - POSTGRES_DB=opendoors_billing
```

## PRIORIDADES EN CONFLICTOS

Si hay conflicto de prioridades:
1. üîí Seguridad y permisos
2. üí∞ L√≥gica fiscal correcta (seg√∫n Joni)
3. üá¶üá∑ Formato argentino de moneda
4. ‚ö° Performance y escalabilidad
5. üé® UX/UI

## ESTRUCTURA IDEAL DE COMMIT

```bash
git commit -m "feat(invoices): Agregar validaci√≥n coherencia montos

- Implementar validar_coherencia_montos() en FinancialCalculator
- Validar subtotal + IVA = total para tipo A
- Tests incluidos

Refs: GUIA_COMPLETA_REPLICACION.txt secci√≥n 4.1"
```

## CONTACT & SUPPORT

**Superadmin**: Franco Corts (cortsfranco@hotmail.com)
**Arquitecto**: Hern√°n (escalabilidad)
**Business Logic**: Joni (l√≥gica fiscal)

---

**√öltima actualizaci√≥n**: 03 de octubre de 2025
**Versi√≥n**: 1.0.0
**Entorno**: Replit (Python 3.11 + FastAPI + PostgreSQL)
